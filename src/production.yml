# 040424, Thursday, 11.00 am 
services: 
  api: &api   # acchor of api to reuse the api content.  
    restart: always 
    build: 
      context: . 
      dockerfile: ./docker/production/django/Dockerfile
    image: api-image
    volumes: 
      - algocode_production_auth_static_volume:/app/staticfiles
      - algocode_production_auth_media_volume:/app/mediafiles 
    env_file: 
      - ./.envs/.production/.django
      - ./.envs/.production/.postgres
    depends_on: 
      - postgres 
      - redis-for-celery
    command: /start  
    networks: 
      - algocode-production-auth-service-network

  postgres: 
    build: 
      context: . 
      dockerfile: ./docker/production/postgres/Dockerfile
    image: pg-image
    volumes: 
      - algocode_production_auth_production_postgres_data:/var/lib/postgresql/data
      - algocode_production_auth_production_postgres_data_backups:/backups
    env_file: 
      - ./.envs/.production/.postgres 
    networks: 
      - algocode-production-auth-service-network

    
  redis-for-celery: 
    image: redis:7-alpine
    networks: 
      - algocode-production-auth-service-network

  celery_worker:   # using anchor of api service. 
    <<: *api 
    image: celery-image
    command: /start-celeryworker
    networks: 
      - algocode-production-auth-service-network
    
  flower: 
    <<: *api 
    image: flower-image
    command: /start-flower
    volumes: 
      - algocode_production_auth_flower_data:/data
    ports: 
      - "5555:5555"
    networks: 
      - algocode-production-auth-service-network
    

# TODO create the network in the server. 
networks: 
  algocode-production-auth-service-network: 
    external: true 
  

volumes: 
  algocode_production_auth_static_volume: {}
  algocode_production_auth_media_volume: {}
  algocode_production_auth_production_postgres_data: {}
  algocode_production_auth_production_postgres_data_backups: {}
  algocode_production_auth_flower_data: {}
  
  